<!DOCTYPE html>
<html>
<head>
    <title>अक्षर-माप अभ्यास</title>

    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            margin: 0;
            background: #f5f6ff;
        }

        .container {
            width: 90%;
            margin: auto;
            background: white;
            padding: 25px;
            margin-top: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #1a3c7c;
        }

        p {
            text-align: center;
            font-size: 18px;
            color: #333;
        }

        .line-box {
            position: relative;
            margin-bottom: 50px;
        }

        /* Sample text to trace */
        .sample-text {
            font-size: 36px;
            color: #999;
            opacity: 0.4;
            user-select: none;
            line-height: 60px;
        }

        /* Bottom line (optional) */
        .writing-line {
            width: 100%;
            height: 50px;
            border-bottom: 2px solid #000;
            margin-top: 10px;
        }

        /* Canvas overlay */
        .traceCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: auto;
        }

        .toolbar {
            text-align: center;
            margin-top: 20px;
        }

        .tool-btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            background: #0e3c7e;
            color: white;
            margin: 0 5px;
            cursor: pointer;
        }

        .tool-btn:hover {
            background: #07275a;
        }
    </style>
</head>

<body>

<div class="container">

    <h1>शिरोरेखा अभ्यास</h1>
    <p>सभी अक्षरों की शीर्ष-रेखा (headline) एक समान रखें।</p>

    {% for item in ["धर्म ,  थकान ,  भोजन ,  आकाश ,  क्षमा , किताब , नमस्ते  भारत  ,  कमल  , नगर ", "सच्ची मेहनत हमेशा रंग लाती है।"] %}
    <div class="line-box">
        <div class="sample-text">{{ item }}</div>
        <canvas class="traceCanvas"></canvas>
        <div class="writing-line"></div>
    </div>
    {% endfor %}

</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()">Undo</button>
    <button class="tool-btn" onclick="clearCanvas()">Clear</button>
    <button class="tool-btn" onclick="downloadImage()">Download</button>
</div>

<script>
// Setup for all canvases
const lineBoxes = document.querySelectorAll('.line-box');
const canvases = [];
const ctxs = [];
const strokesArr = [];

lineBoxes.forEach((box, idx) => {
    const canvas = box.querySelector('.traceCanvas');
    canvas.width = box.clientWidth;
    canvas.height = box.clientHeight;
    canvases.push(canvas);
    ctxs.push(canvas.getContext('2d'));
    strokesArr.push([]);
});

// Resize canvases on window resize
window.addEventListener('resize', () => {
    canvases.forEach((canvas, idx) => {
        const box = lineBoxes[idx];
        const tempStrokes = strokesArr[idx];
        canvas.width = box.clientWidth;
        canvas.height = box.clientHeight;
        redraw(idx);
        strokesArr[idx] = tempStrokes;
    });
});

let current = [];
let drawing = false;
let activeIdx = null;

// Pointer events
canvases.forEach((canvas, idx) => {
    canvas.addEventListener('pointerdown', (e) => {
        drawing = true;
        current = [];
        activeIdx = idx;
        addPoint(e, false);
    });
    canvas.addEventListener('pointermove', (e) => {
        if (!drawing || activeIdx !== idx) return;
        addPoint(e, true);
    });
    canvas.addEventListener('pointerup', () => {
        if (drawing && activeIdx === idx) {
            drawing = false;
            strokesArr[idx].push(current);
        }
    });
});

function addPoint(e, drawNow) {
    const rect = canvases[activeIdx].getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const pressure = e.pressure || 0.5;

    current.push({x, y, pressure});

    if (drawNow) {
        const ctx = ctxs[activeIdx];
        let prev = current[current.length - 2];
        if (!prev) return;
        ctx.lineWidth = pressure * 6;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.beginPath();
        ctx.moveTo(prev.x, prev.y);
        ctx.lineTo(x, y);
        ctx.stroke();
    }
}

// Redraw function
function redraw(idx) {
    const ctx = ctxs[idx];
    ctx.clearRect(0, 0, canvases[idx].width, canvases[idx].height);
    strokesArr[idx].forEach(stroke => {
        for (let i = 1; i < stroke.length; i++) {
            ctx.lineWidth = stroke[i].pressure * 6;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(stroke[i-1].x, stroke[i-1].y);
            ctx.lineTo(stroke[i].x, stroke[i].y);
            ctx.stroke();
        }
    });
}

// Undo last stroke (from last active canvas)
function undo() {
    if (activeIdx === null) return;
    strokesArr[activeIdx].pop();
    redraw(activeIdx);
}

// Clear all strokes (from all canvases)
function clearCanvas() {
    strokesArr.forEach((_, idx) => {
        strokesArr[idx] = [];
        ctxs[idx].clearRect(0, 0, canvases[idx].width, canvases[idx].height);
    });
}

// Download as image (combined)
function downloadImage() {
    const totalHeight = lineBoxes[0].parentNode.scrollHeight;
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = lineBoxes[0].clientWidth;
    tempCanvas.height = totalHeight;
    const tempCtx = tempCanvas.getContext('2d');

    lineBoxes.forEach((box, idx) => {
        tempCtx.drawImage(canvases[idx], 0, box.offsetTop, box.clientWidth, box.clientHeight);
    });

    const link = document.createElement('a');
    link.download = 'devanagari_practice.png';
    link.href = tempCanvas.toDataURL();
    link.click();
}
</script>

</body>
</html>