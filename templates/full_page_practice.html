{% extends "layout.html" %}
{% block content %}

<h2 style="text-align:center;">{{ heading }}</h2>

<style>
.practice-area {
    position: relative;
    width: 90%;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.practice-line {
    font-size: 38px;
    margin: 20px 0;
    font-family: 'Segoe UI', sans-serif;
    color: #444;
    opacity: 0.5;
    user-select: none;
}
#traceCanvas {
    position: absolute;
    top: 0;
    left: 0;
}
.toolbar {
    margin-top: 15px;
    text-align: center;
}
.tool-btn {
    padding: 8px 15px;
    border-radius: 6px;
    border: none;
    background: #007bff;
    color: white;
    margin: 0 5px;
    cursor: pointer;
}
.tool-btn:hover {
    background: #0056b3;
}
</style>

<div class="practice-area" id="practiceArea">

    <!-- Worksheet Text -->
    <div id="worksheetContainer">
        {% if lines %}
            {% for line in lines %}
                <div class="practice-line">{{ line }}</div>
            {% endfor %}
        {% else %}
            <div class="practice-line">{{ trace_text }}</div>
        {% endif %}
    </div>

    <!-- Drawing Canvas -->
    <canvas id="traceCanvas"></canvas>

</div>

<div class="toolbar">
    <button class="tool-btn" onclick="undo()">Undo</button>
    <button class="tool-btn" onclick="clearCanvas()">Clear</button>
    <button class="tool-btn" onclick="downloadImage()">Download</button>
</div>

<script>
// Resize canvas to match worksheet height
function resizeCanvas() {
    let area = document.getElementById("practiceArea");
    let canvas = document.getElementById("traceCanvas");
    canvas.width = area.clientWidth;
    canvas.height = area.clientHeight;
}
resizeCanvas();
window.onresize = resizeCanvas;

// Drawing
const canvas = document.getElementById("traceCanvas");
const ctx = canvas.getContext("2d");

let drawing = false;
let strokes = [];
let currentStroke = [];

canvas.addEventListener('pointerdown', (e) => {
    drawing = true;
    currentStroke = [];
    addPoint(e);
});
canvas.addEventListener('pointermove', (e) => {
    if (!drawing) return;
    addPoint(e, true);
});
canvas.addEventListener('pointerup', () => {
    drawing = false;
    strokes.push(currentStroke);
});

// Draw with pressure
function addPoint(e, draw = false) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const pressure = e.pressure || 0.5;

    currentStroke.push({ x, y, pressure });

    if (draw) {
        ctx.lineWidth = pressure * 6;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";

        const last = currentStroke[currentStroke.length - 2];
        if (!last) return;

        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(x, y);
        ctx.stroke();
    }
}

// Undo
function undo() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    strokes.pop();
    redraw();
}
function redraw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    strokes.forEach(stroke => {
        for (let i = 1; i < stroke.length; i++) {
            ctx.lineWidth = stroke[i].pressure * 6;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";

            ctx.beginPath();
            ctx.moveTo(stroke[i-1].x, stroke[i-1].y);
            ctx.lineTo(stroke[i].x, stroke[i].y);
            ctx.stroke();
        }
    });
}

// Clear
function clearCanvas() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    strokes = [];
}

// Download
function downloadImage() {
    let link = document.createElement('a');
    link.download = "worksheet_practice.png";
    link.href = canvas.toDataURL();
    link.click();
}
</script>

{% endblock %}